/* --- CHAPTER DATA & CONFIGURATION --- */
const storyChapters = [
    {
        id: 1,
        number: "Chapter 01",
        title: "體育館後的紫色身影",
        desc: "Cindy 剛加入園藝社，卻發現社團活動地點就在排球部練習的第一體育館旁邊。那一刻，命運的齒輪開始轉動...",
        date: "2024.04.12",
        content: `
            <div class="story-paragraph">四月的午後，空氣中還帶著微涼的濕氣。Cindy 抱著剛領到的園藝剪刀，有些侷促地站在第一體育館後的空地旁。</div>
            <div class="story-timestamp">Nekoma High - 15:45 PM</div>
            <div class="story-bubble left">
                <div class="story-avatar"><img src="img/CindyQQ(Transparent).png" alt="Cindy"></div>
                <div class="story-bubble-content">
                    <span class="sb-speaker">Cindy</span>
                    「這裡的土壤...看起來很適合種紫羅蘭呢。」
                </div>
            </div>
            <div class="story-paragraph">正當她蹲下身子觀察土壤時，體育館內傳來一陣節奏明快的球鞋摩擦地板聲。緊接著，是一聲沉穩的「好球」。</div>
            <div class="story-paragraph">Cindy 下意識地抬頭，透過體育館側門的縫隙，她看見了一個黑色頭髮、眼神銳利的學長。他高高躍起，動作優雅得像是一隻在黑夜中狩獵的貓。</div>
        `
    },
    {
        id: 2,
        number: "Chapter 02",
        title: "名為「黑尾」的觀察日記",
        desc: "Cindy 開始在社團日誌的角落記錄關於那個學長的一切。今天他穿了紅色的運動服，今天他在笑...",
        date: "2024.05.05",
        content: `
            <div class="story-paragraph">一個月過去了，Cindy 發現自己對園藝社的熱情中，混入了一些私心。</div>
            <div class="story-bubble right">
                <div class="story-avatar"><img src="img/KurooQQ(Transparent).png" alt="Kuroo"></div>
                <div class="story-bubble-content">
                    <span class="sb-speaker">黑尾</span>
                    「喂，研磨，那邊那個學妹是不是每天都蹲在那裡看草？」
                </div>
            </div>
            <div class="story-paragraph">Cindy 嚇得趕緊把頭埋進葉叢裡。她聽到了學長的笑聲，那是一種帶著些許戲謔，卻又意外溫柔的聲音。</div>
            <div class="story-paragraph">他在觀察球，而她在觀察他。</div>
        `
    }
];

const gardenLogs = [
    { date: "2024.06.01", title: "向日葵與紅球衣", weather: "☀️", preview: "今天天氣很好，體育館窗戶開著。我看見黑尾前輩跳得很高，像是在抓太陽...", status: "記錄中" },
    { date: "2024.06.15", title: "雨天的躲雨時分", weather: "🌧️", preview: "突然下大雨了，沒帶傘。學長在走廊跟我打了招呼，心跳快得要停了。", status: "完結" }
];

/* --- UI CONTROLLER FUNCTIONS --- */
function toggleDarkMode() {
    const body = document.body;
    const icon = document.getElementById('darkModeIcon');
    body.classList.toggle('dark-mode');
    icon.textContent = body.classList.contains('dark-mode') ? '☀️' : '🌙';
}

function scrollToId(id) {
    const el = document.getElementById(id);
    if (el) {
        window.scrollTo({ top: el.offsetTop - 120, behavior: 'smooth' });
    }
}

function switchTopTab(tabId) {
    document.querySelectorAll('.top-tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.filter-bar-container#top-filter-anchor .filter-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
}

function toggleTab(tabId) {
    document.querySelectorAll('.tab-section').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.filter-bar-container#filter-bar-anchor .filter-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
}

/* --- TAB NAVIGATION --- */
function switchTopTabAndScroll(tabId) {
    switchTopTab(tabId);
    const btnId = tabId === 'top-tab-video' ? 'btn-top-video' : 'btn-top-relationship';
    document.getElementById(btnId).classList.add('active');
    scrollToId('top-filter-anchor');
}

function switchTabAndScroll(tabId) {
    toggleTab(tabId);
    const btnMap = { 'interview-zone': 'btn-interview', 'storybook-zone': 'btn-storybook', 'timeline-zone': 'btn-timeline' };
    document.getElementById(btnMap[tabId]).classList.add('active');
    scrollToId('filter-bar-anchor');
}

/* --- STORYBOOK SYSTEM --- */
let currentChapterIdx = 0;

function renderStoryChapters() {
    const container = document.getElementById('chapters-container');
    if (!container) return;
    container.innerHTML = storyChapters.map((ch, index) => `
        <div class="chapter-card" onclick="openChapterReader(${index})">
            <div class="chapter-number">${ch.number}</div>
            <div class="chapter-title">${ch.title}</div>
            <div class="chapter-desc">${ch.desc}</div>
            <div class="chapter-date">📅 ${ch.date}</div>
        </div>
    `).join('');
}

function openChapterReader(index) {
    currentChapterIdx = index;
    const ch = storyChapters[index];
    document.getElementById('chapters-grid-view').style.display = 'none';
    const reader = document.getElementById('story-reader-view');
    reader.style.display = 'block';
    document.getElementById('reader-title').textContent = ch.title;
    document.getElementById('reader-date').textContent = ch.date;
    document.getElementById('reader-content').innerHTML = ch.content;
    document.getElementById('reader-progress').textContent = `${index + 1} / ${storyChapters.length}`;
    document.getElementById('reader-prev-btn').disabled = index === 0;
    document.getElementById('reader-next-btn').disabled = index === storyChapters.length - 1;
    reader.scrollIntoView({ behavior: 'smooth' });
}

function closeChapterReader() {
    document.getElementById('story-reader-view').style.display = 'none';
    document.getElementById('chapters-grid-view').style.display = 'block';
}

function navigateChapter(dir) {
    const nextIdx = currentChapterIdx + dir;
    if (nextIdx >= 0 && nextIdx < storyChapters.length) openChapterReader(nextIdx);
}

/* --- GARDEN LOGS --- */
function renderGardenLogs() {
    const container = document.getElementById('garden-container');
    if (!container) return;
    container.innerHTML = gardenLogs.map(log => `
        <div class="garden-card">
            <div class="garden-header">
                <span class="garden-date">${log.date}</span>
                <span class="garden-weather">${log.weather}</span>
            </div>
            <div class="garden-title">${log.title}</div>
            <div class="garden-preview">${log.preview}</div>
            <div class="garden-status"><span class="status-dot"></span>${log.status}</div>
        </div>
    `).join('');
}

/* --- MODAL SYSTEM --- */
function openModal(content) {
    const modal = document.getElementById('eventModal');
    document.getElementById('modalBody').innerHTML = content;
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    document.getElementById('eventModal').classList.remove('active');
    document.body.style.overflow = 'auto';
}

window.onclick = e => { if (e.target.classList.contains('modal')) closeModal(); };

/* --- SCROLL SYSTEM --- */
function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

window.onscroll = () => {
    const btn = document.getElementById('scrollTopBtn');
    if (window.scrollY > 500) btn.classList.add('visible');
    else btn.classList.remove('visible');
};

/* --- INITIALIZATION --- */
document.addEventListener('DOMContentLoaded', () => {
    renderStoryChapters();
    renderGardenLogs();
    
    // Timeline buttons listener
    document.querySelectorAll('.read-story-btn').forEach((btn, idx) => {
        btn.onclick = (e) => {
            e.stopPropagation();
            const eventTitles = ["🖤「愛的暗殺事件🌱」", "🖤「圖書館書本空襲事件📕」", "🖤「左腳的愛過於沉重🦶備」"];
            const eventDescs = [
                "Cindy 領養了一盆據說「絕對不會死」的仙人掌。出於對新生命的過度關愛，她每天瘋狂澆水，結果仙人掌在第三天就淹死了... 黑尾學長看到後，默默地送了她一盆新的，並附上紙條：『這次一天一次就好。』",
                "Cindy 在圖書館想取最上層的書時，因為身高不足，書本傾斜砸向她的頭。正當她閉上眼時，一隻手穩穩地接住了那本厚書。黑尾學長從她身後靠過來：『矮個子就乖乖喊一聲學長幫忙啊。』",
                "黑尾生日那天，Cindy 緊張地送出禮物。沒想到因為太害羞，包裝時拿錯了兩盒護膝，結果黑尾打開發現裡面全是左腳用的。黑尾大笑著穿上：『沒關係，這說明妳對我的左腳關愛加倍。』"
            ];
            openModal(`
                <div class="story-header">
                    <h2 class="story-chapter-title">${eventTitles[idx]}</h2>
                </div>
                <div class="story-paragraph">${eventDescs[idx]}</div>
            `);
        };
    });
});
